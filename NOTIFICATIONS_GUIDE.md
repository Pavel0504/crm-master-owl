# Руководство по Push Уведомлениям - Master Owl CRM

## Обзор

В приложение Master Owl CRM добавлена система push уведомлений, которая автоматически информирует пользователя о:

1. **Низких остатках материалов** - когда остаток материала падает ниже 40% (красная зона)
2. **Истекающих сроках заказов** - когда до окончания срока заказа остается 2 дня или менее

## Компоненты системы

### 1. Фавикон с совой
- Создан SVG фавикон `/public/favicon.svg` с символом совы
- Автоматически отображается во вкладке браузера
- Соответствует дизайну приложения (оранжевый градиент)

### 2. Хук useNotifications
**Файл:** `src/hooks/useNotifications.ts`

Предоставляет функции для:
- Запроса разрешения на уведомления
- Проверки низких остатков материалов
- Проверки истекающих сроков заказов
- Автоматической проверки всех уведомлений

**Основные функции:**
```typescript
const {
  permissionState,        // Состояние разрешения уведомлений
  requestPermission,      // Запросить разрешение у пользователя
  checkMaterialsLowStock, // Проверить низкие остатки материалов
  checkOrdersDeadline,    // Проверить истекающие сроки заказов
  checkAllNotifications   // Проверить все уведомления сразу
} = useNotifications(userId);
```

### 3. Компонент NotificationManager
**Файл:** `src/components/NotificationManager.tsx`

Управляет отображением и логикой уведомлений:

#### Баннер запроса разрешения
- Появляется через 3 секунды после входа в систему
- Отображается только если пользователь еще не дал разрешение
- Можно закрыть или отложить

#### Плавающая кнопка проверки
- Появляется в правом нижнем углу после получения разрешения
- Позволяет вручную проверить все уведомления
- С анимацией пульсации во время проверки

#### Автоматическая проверка
- Происходит при входе в систему
- Повторяется каждый час автоматически
- Работает в фоновом режиме

### 4. Service Worker
**Файл:** `public/service-worker.js`

Обрабатывает:
- Клики по уведомлениям (возвращает фокус на приложение)
- Закрытие уведомлений (логирование)

## Логика уведомлений

### Уведомления о низких остатках материалов

**Условия срабатывания:**
- Остаток материала < 40% (красная зона)
- Остаток материала > 0% (не полностью израсходован)

**Содержание уведомления:**
- Заголовок: "Низкий остаток материала!"
- Текст: "{Название материала}: осталось {процент}%"
- Иконка: Сова из приложения

**Пример:**
```
Низкий остаток материала!
Шерстяная пряжа: осталось 25%
```

### Уведомления о истекающих сроках заказов

**Условия срабатывания:**
- До срока выполнения осталось 0, 1 или 2 дня
- Статус заказа: "В процессе" или "На утверждении"
- Заказ не отменен и не выполнен

**Содержание уведомления:**
- Заголовок: "Скоро истекает срок заказа!"
- Текст (в зависимости от дней):
  - 0 дней: "Заказ №{номер}: срок истекает сегодня!"
  - 1 день: "Заказ №{номер}: срок истекает завтра!"
  - 2 дня: "Заказ №{номер}: осталось 2 дня до срока!"
- Требует взаимодействия (не закроется автоматически)

**Пример:**
```
Скоро истекает срок заказа!
Заказ №15: срок истекает завтра!
```

## Как это работает

### 1. Первый вход пользователя
1. Пользователь входит в систему
2. Через 3 секунды появляется баннер с предложением включить уведомления
3. Пользователь может:
   - Нажать "Включить" → разрешение запрашивается
   - Нажать "Не сейчас" → баннер скрывается
   - Закрыть баннер кнопкой X

### 2. После получения разрешения
1. Автоматически проверяются все материалы и заказы
2. Отображаются уведомления (если есть проблемы)
3. В правом нижнем углу появляется кнопка проверки
4. Каждый час происходит автоматическая проверка

### 3. Ручная проверка
1. Пользователь нажимает на кнопку с колокольчиком
2. Происходит проверка материалов и заказов
3. Если проблем нет, показывается уведомление "Все в порядке!"
4. Если есть проблемы, показываются соответствующие уведомления

### 4. Клик по уведомлению
1. Уведомление закрывается
2. Если приложение открыто в другой вкладке → фокус переключается на него
3. Если приложение закрыто → открывается новая вкладка

## Технические детали

### Частота проверок
- **При входе:** Сразу после получения разрешения
- **Автоматически:** Каждые 60 минут (1 час)
- **Вручную:** По требованию пользователя (кнопка с колокольчиком)

### Управление дубликатами
- Используется поле `tag` для предотвращения дублирования
- Для материалов: `material-{id}`
- Для заказов: `order-{id}`
- Браузер автоматически заменяет старое уведомление новым с тем же тегом

### Состояния разрешения

1. **default** (не запрошено)
   - Показывается баннер с предложением
   - Кнопка проверки не отображается

2. **granted** (разрешено)
   - Баннер скрыт
   - Показывается кнопка проверки
   - Уведомления работают

3. **denied** (запрещено)
   - Показывается серая кнопка с перечеркнутым колокольчиком
   - Уведомления не работают
   - Пользователь должен изменить настройки в браузере вручную

### Поддержка браузеров
- ✅ Chrome/Edge (Desktop & Mobile)
- ✅ Firefox (Desktop & Mobile)
- ✅ Safari (Desktop & Mobile, iOS 16.4+)
- ✅ Opera
- ❌ Internet Explorer (не поддерживается)

## Настройка в браузере

### Chrome/Edge
1. Нажмите на иконку замка в адресной строке
2. Выберите "Настройки сайта"
3. Найдите "Уведомления"
4. Выберите "Разрешить" или "Блокировать"

### Firefox
1. Нажмите на иконку замка/щита в адресной строке
2. Выберите "Права доступа"
3. Найдите "Уведомления"
4. Выберите нужную опцию

### Safari
1. Safari → Настройки → Веб-сайты → Уведомления
2. Найдите ваш сайт в списке
3. Выберите "Разрешить" или "Запретить"

## Визуальный дизайн

### Баннер запроса разрешения
- Положение: Нижний правый угол (мобильный: на всю ширину внизу)
- Фон: Белый (светлая тема) / Темно-серый (темная тема)
- Иконка: Колокольчик в оранжевом круге
- Анимация: Плавное появление снизу

### Кнопка проверки
- Размер: 56x56px (14rem круг)
- Цвет: Оранжевый градиент (светлая тема) / Бордовый градиент (темная тема)
- Иконка: Колокольчик (белый)
- Анимация: Масштабирование при наведении, пульсация при проверке
- Тень: Большая тень с усилением при наведении

### Уведомления
- Иконка: Сова из `/icons/icon-192x192.svg`
- Бейдж: Та же сова
- Звук: Стандартный звук браузера
- Время: Материалы - закрываются автоматически, Заказы - требуют взаимодействия

## Примеры использования

### Программная проверка
```typescript
import { useNotifications } from '../hooks/useNotifications';

function MyComponent() {
  const { user } = useAuth();
  const { checkAllNotifications, permissionState } = useNotifications(user?.id);

  const handleCheck = async () => {
    if (permissionState.permission === 'granted') {
      const result = await checkAllNotifications();
      console.log(`Найдено: ${result.materials} материалов, ${result.orders} заказов`);
    }
  };

  return <button onClick={handleCheck}>Проверить</button>;
}
```

### Запрос разрешения
```typescript
const { requestPermission } = useNotifications(userId);

const handleEnable = async () => {
  const granted = await requestPermission();
  if (granted) {
    console.log('Уведомления включены!');
  } else {
    console.log('Пользователь отклонил запрос');
  }
};
```

## Решение проблем

### Уведомления не приходят
1. Проверьте разрешение в настройках браузера
2. Убедитесь что приложение открыто или Service Worker активен
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь что есть материалы/заказы соответствующие условиям

### Баннер не появляется
1. Проверьте что разрешение не было дано ранее
2. Подождите 3 секунды после входа
3. Обновите страницу

### Кнопка проверки не работает
1. Убедитесь что разрешение дано
2. Проверьте подключение к интернету (для запросов к Supabase)
3. Откройте консоль для просмотра ошибок

## Безопасность и приватность

- Уведомления создаются локально на устройстве пользователя
- Никакие данные не отправляются на внешние серверы
- Запросы к Supabase происходят от имени авторизованного пользователя
- Пользователь может отозвать разрешение в любой момент
- Уведомления не сохраняются после закрытия

## Будущие улучшения

Возможные расширения функционала:
- Настройка частоты проверок
- Выбор типов уведомлений (включить/выключить отдельно)
- Настройка порогов (не только 40%, но и другие значения)
- Уведомления о новых заказах
- Уведомления о завершенных заказах
- История уведомлений

---

**Готово!** Система push уведомлений полностью интегрирована и готова к использованию.
